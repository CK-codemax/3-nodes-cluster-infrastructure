---
- name: Setup kubectl autocomplete and alias
  hosts: masters
  become: false
  gather_facts: true
  
  tasks:
    - name: Check if Helm is installed
      command: helm version
      register: helm_check
      failed_when: false
      changed_when: false

    - name: Download Helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get-helm-3.sh
        mode: '0755'
      when: helm_check.rc != 0

    - name: Install Helm
      command: /tmp/get-helm-3.sh
      args:
        creates: /usr/local/bin/helm
      when: helm_check.rc != 0
      become: true
      register: helm_install
      changed_when: helm_install.rc == 0

    - name: Verify Helm installation
      command: helm version
      register: helm_version
      changed_when: false

    - name: Display Helm version
      debug:
        msg: "Helm installed: {{ helm_version.stdout }}"
      when: helm_version.rc == 0

    - name: Setup kubectl bash completion
      shell: |
        bash -c "source <(kubectl completion bash)"
        echo "source <(kubectl completion bash)" >> ~/.bashrc
      register: kubectl_completion
      changed_when: false
      
    - name: Create kubectl alias 'k'
      shell: |
        bash -c "alias k=kubectl"
        bash -c "complete -o default -F __start_kubectl k"
        echo "alias k=kubectl" >> ~/.bashrc
        echo "complete -o default -F __start_kubectl k" >> ~/.bashrc
      register: kubectl_alias
      changed_when: false
      
    - name: Reload bashrc
      shell: bash -c "source ~/.bashrc"
      register: bashrc_reload
      changed_when: false
      
    - name: Display kubectl setup completion
      debug:
        msg: "{{ inventory_hostname }}: kubectl autocomplete and alias 'k' setup completed"
