---
- name: Install Calico CNI
  hosts: master1
  become: true
  gather_facts: true
  vars_files:
    - ../vars/main.yml

  tasks:
    - name: Apply Calico CNI manifest
      shell: |
        kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: calico_apply

    - name: Display Calico installation output
      debug:
        var: calico_apply.stdout_lines

    - name: Wait for Calico pods to be running
      shell: |
        kubectl get pods -n kube-system -l k8s-app=calico-node --field-selector=status.phase=Running --no-headers | wc -l
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: calico_pods_running
      until: calico_pods_running.stdout | int >= 3
      retries: 30
      delay: 10
      changed_when: false

    - name: Display Calico pods status
      shell: |
        kubectl get pods -n kube-system -l k8s-app=calico-node
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: calico_pods_status
      changed_when: false

    - name: Show Calico pods status
      debug:
        var: calico_pods_status.stdout_lines

