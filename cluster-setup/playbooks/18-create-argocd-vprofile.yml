---
- name: Create ArgoCD VProfile Project and Application
  hosts: master1
  become: true
  gather_facts: true
  vars_files:
    - ../vars/main.yml

  tasks:
    - name: Remove existing repository directory if it exists
      file:
        path: /tmp/argocd-vprofile-repo
        state: absent

    - name: Clone git repository
      git:
        repo: "{{ argocd_app_repo_url }}"
        dest: /tmp/argocd-vprofile-repo
        version: "{{ argocd_app_repo_target_revision }}"
        force: yes

    - name: Display repository contents
      shell: |
        ls -la /tmp/argocd-vprofile-repo/
        echo "---"
        if [ -d /tmp/argocd-vprofile-repo/argo-project ]; then
          echo "argo-project directory contents:"
          ls -la /tmp/argocd-vprofile-repo/argo-project/
        fi
      register: repo_contents
      changed_when: false

    - name: Show repository contents
      debug:
        var: repo_contents.stdout_lines

    - name: Display Application manifest content
      shell: |
        if [ -f /tmp/argocd-vprofile-repo/argo-project/vprofile-app.yaml ]; then
          cat /tmp/argocd-vprofile-repo/argo-project/vprofile-app.yaml
        elif [ -f /tmp/argocd-vprofile-repo/argo-project/application.yaml ]; then
          cat /tmp/argocd-vprofile-repo/argo-project/application.yaml
        else
          find /tmp/argocd-vprofile-repo -name "*.yaml" -o -name "*.yml" | head -5
        fi
      register: manifest_content
      changed_when: false
      failed_when: false

    - name: Show Application manifest content
      debug:
        var: manifest_content.stdout_lines
      when: manifest_content.stdout_lines is defined

    - name: Apply ArgoCD project and application manifests
      shell: |
        cd /tmp/argocd-vprofile-repo/argo-project && kubectl apply -f .
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: manifests_apply
      changed_when: "'created' in manifests_apply.stdout or 'configured' in manifests_apply.stdout"

    - name: Verify ArgoCD AppProject is created
      shell: |
        kubectl get appproject {{ argocd_project_name }} -n {{ argocd_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: project_status
      changed_when: false
      failed_when: false

    - name: Show AppProject status
      debug:
        var: project_status.stdout_lines
      when: project_status.rc == 0

    - name: Wait for resources to be ready
      pause:
        seconds: 5

    - name: Verify ArgoCD Application is created
      shell: |
        kubectl get application {{ argocd_app_name }} -n {{ argocd_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: app_status
      changed_when: false
      failed_when: false

    - name: Show Application status
      debug:
        var: app_status.stdout_lines
      when: app_status.rc == 0

    - name: Display Application details
      shell: |
        kubectl describe application {{ argocd_app_name }} -n {{ argocd_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: app_details
      changed_when: false
      failed_when: false

    - name: Show Application details
      debug:
        var: app_details.stdout_lines
      when: app_details.rc == 0

